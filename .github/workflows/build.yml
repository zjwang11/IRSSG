name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Decompress repo data (identify.pkl, symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f src_mom2ssg/ssg_data/identify.pkl.tar.gz ]; then
            tar -xzf src_mom2ssg/ssg_data/identify.pkl.tar.gz -C src_mom2ssg/ssg_data
          fi
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Remove prebuilt shared objects from repo
        run: |
          set -euxo pipefail
          rm -f src_mom2ssg/smith_form/libintlng.so || true

      - name: Build wheels (manylinux2014, x86_64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux2014"
          # Allow pre-release Python downloads if needed (e.g., 3.14/3.14t)
          CIBW_PRERELEASE_PYTHONS: "1"
          # Enable free-threaded (t) wheels for CPython where available (e.g., cp313t)
          CIBW_FREE_THREADED_SUPPORT: "1"
          # Use pyproject.toml build selector
        with:
          output-dir: wheelhouse

      - name: Build wheels (manylinux_2_28, x86_64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_28"
          # Allow pre-release Python downloads (e.g., 3.14 / 3.14t when not GA)
          CIBW_PRERELEASE_PYTHONS: "1"
          # Enable free-threaded (t) wheels
          CIBW_FREE_THREADED_SUPPORT: "1"
          # Use pyproject.toml build selector
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test 3.14t/3.14 and 3.13t/3.13, then 3.12 â†’ 3.8
        python-version: ['3.14t','3.14','3.13t','3.13','3.12','3.11','3.10','3.9','3.8']
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Decompress repo test data (symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Preinstall runtime deps (prefer wheels; fallback to source)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          # Prefer binary wheels; try a wheels-only resolution first
          export PIP_PREFER_BINARY=1
          export PIP_CONSTRAINT=constraints.txt
          if ! python -m pip install -c constraints.txt --only-binary=:all: \
              numpy scipy spglib pymatgen phonopy h5py; then
            echo "No full wheel solution found; allowing sdist fallback..."
            python -m pip install -c constraints.txt \
              numpy scipy spglib pymatgen phonopy h5py
          fi
          # Ensure importlib_resources for Python < 3.9 using shell logic to avoid heredoc
          if python -c "import sys; import importlib.util; sys.exit(0 if sys.version_info >= (3,9) or importlib.util.find_spec('importlib_resources') else 1)"; then
            echo "importlib_resources not needed or already installed"
          else
            python -m pip install -c constraints.txt --only-binary=:all: importlib_resources \
            || python -m pip install -c constraints.txt importlib_resources
          fi

      - name: Install and test both manylinux wheels
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          # Ensure importlib_resources for Python < 3.9 (fallback used by CLI)
          if python -c "import sys; import importlib.util; sys.exit(0 if sys.version_info >= (3,9) or importlib.util.find_spec('importlib_resources') else 1)"; then
            echo "importlib_resources not needed or already installed"
          else
            python -m pip install --only-binary=:all: importlib_resources \
            || python -m pip install importlib_resources
          fi
          # Determine wheel Python tag, accounting for free-threaded (t) builds
          pyver=$(python -c "import sys, sysconfig; m=sys.version_info; tag=f'cp{m.major}{m.minor}'; so=sysconfig.get_config_var('SOABI') or ''; print(tag + ('t' if f'{m.major}{m.minor}t' in so else ''))")
          # Iterate over wheel tags we expect to produce and test each if present
          for tag in manylinux_2_28 manylinux_2_17 manylinux2014; do
            w=$(ls dist/*${pyver}*${tag}*x86_64.whl 2>/dev/null | head -n1 || true)
            if [ -n "${w:-}" ]; then
              echo "Installing wheel: $w"
              python -m pip install --no-deps --force-reinstall "$w"
              tmpdir=$(mktemp -d)
              cd "$tmpdir"
              python -c "import os, irssg, irssg.cli; import irssg.ssg.MOM2SSG as m; base=os.path.dirname(irssg.__file__); print('import-ok', '${tag}', 'base=', base, 'has_ssg=', os.path.isdir(os.path.join(base,'ssg')), 'mom2ssg=', m.__name__)"
              cd -
            fi
          done

      - name: Run irssg PW/WANN tests (if present)
        run: |
          set -euxo pipefail
          if [ -d test/pw ]; then
            echo "Found ./test/pw; running PW test..."
            pushd test/pw
            echo "Command: irssg -nk 1 3 -nb 101 112"
            timeout 120s irssg -nk 1 3 -nb 101 112 | tee run.log || true
            echo "Checking for TOTAL END in PW log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/pw directory. Skipping PW test."
          fi

          if [ -d test/wann ]; then
            echo "Found ./test/wann; running WANN test..."
            pushd test/wann
            echo "Command: irssg -wann -nk 1 3 -nb 11 72"
            timeout 120s irssg -wann -nk 1 3 -nb 11 72 | tee run.log || true
            echo "Checking for TOTAL END in WANN log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/wann directory. Skipping WANN test."
          fi
