name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build wheels with cibuildwheel (Linux only)
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Install wheel (with deps)
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import irssg_pkg, irssg_pkg.cli; print('import-ok')"
          python -c "import irssg_pkg.ssg.MOM2SSG as m; print('mom2ssg-ok', m.__name__)"

      - name: Run irssg in test directory (if present)
        run: |
          set -euxo pipefail
          if [ -d test ]; then
            echo "Found ./test directory; running irssg..."
            cd test
            timeout 90s irssg | tee run.log || true
            echo "Last line:"; tail -1 run.log || true
            tail -1 run.log | grep -q "TOTAL END"
          else
            echo "No ./test directory. Skipping runtime test."
          fi
