name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Decompress repo data (identify.pkl, symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f src_mom2ssg/ssg_data/identify.pkl.tar.gz ]; then
            tar -xzf src_mom2ssg/ssg_data/identify.pkl.tar.gz -C src_mom2ssg/ssg_data
          fi
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Remove prebuilt shared objects from repo
        run: |
          set -euxo pipefail
          rm -f src_mom2ssg/smith_form/libintlng.so || true

      - name: Build wheels (manylinux2014, x86_64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux2014"
          # Allow pre-release Python downloads if needed (e.g., 3.14/3.14t)
          CIBW_PRERELEASE_PYTHONS: "1"
          # Enable free-threaded (t) wheels for CPython where available (e.g., cp313t)
          CIBW_FREE_THREADED_SUPPORT: "1"
          # Use pyproject.toml build selector
        with:
          output-dir: wheelhouse

      - name: Build wheels (manylinux_2_28, x86_64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_28"
          # Allow pre-release Python downloads (e.g., 3.14 / 3.14t when not GA)
          CIBW_PRERELEASE_PYTHONS: "1"
          # Enable free-threaded (t) wheels
          CIBW_FREE_THREADED_SUPPORT: "1"
          # Use pyproject.toml build selector
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test 3.14t/3.14 and 3.13t/3.13, then 3.12 â†’ 3.8
        python-version: ['3.14t','3.14','3.13t','3.13','3.12','3.11','3.10','3.9','3.8']
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Decompress repo test data (symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Preinstall runtime deps (prefer wheels; fallback to source)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          # Prefer binary wheels; try a wheels-only resolution first
          export PIP_PREFER_BINARY=1
          export PIP_CONSTRAINT=constraints.txt
          if ! python -m pip install -c constraints.txt --only-binary=:all: \
              numpy scipy spglib pymatgen phonopy h5py; then
            echo "No full wheel solution found; allowing sdist fallback..."
            python -m pip install -c constraints.txt \
              numpy scipy spglib pymatgen phonopy h5py
          fi
          # Ensure importlib_resources for Python < 3.9 using shell logic to avoid heredoc
          if python -c "import sys; import importlib.util; sys.exit(0 if sys.version_info >= (3,9) or importlib.util.find_spec('importlib_resources') else 1)"; then
            echo "importlib_resources not needed or already installed"
          else
            python -m pip install -c constraints.txt --only-binary=:all: importlib_resources \
            || python -m pip install -c constraints.txt importlib_resources
          fi

      - name: Install and test both manylinux wheels
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          # Ensure importlib_resources for Python < 3.9 (fallback used by CLI)
          if python -c "import sys; import importlib.util; sys.exit(0 if sys.version_info >= (3,9) or importlib.util.find_spec('importlib_resources') else 1)"; then
            echo "importlib_resources not needed or already installed"
          else
            python -m pip install --only-binary=:all: importlib_resources \
            || python -m pip install importlib_resources
          fi
          # Determine wheel Python tag, accounting for free-threaded (t) builds
          pyver=$(python -c "import sys, sysconfig; m=sys.version_info; tag=f'cp{m.major}{m.minor}'; so=sysconfig.get_config_var('SOABI') or ''; print(tag + ('t' if f'{m.major}{m.minor}t' in so else ''))")
          # Iterate over wheel tags we expect to produce and test each if present
          for tag in manylinux_2_28 manylinux_2_17 manylinux2014; do
            w=$(ls dist/*${pyver}*${tag}*x86_64.whl 2>/dev/null | head -n1 || true)
            if [ -n "${w:-}" ]; then
              echo "Installing wheel: $w"
              python -m pip install --no-deps --force-reinstall "$w"
              tmpdir=$(mktemp -d)
              cd "$tmpdir"
              python -c "import os, irssg, irssg.cli; import irssg.ssg.MOM2SSG as m; base=os.path.dirname(irssg.__file__); print('import-ok', '${tag}', 'base=', base, 'has_ssg=', os.path.isdir(os.path.join(base,'ssg')), 'mom2ssg=', m.__name__)"
              cd -
            fi
          done

      - name: Debug irssg binary (path + ldd)
        run: |
          set -euxo pipefail
          IRSSG_BIN=$(python -c "import os; os.chdir('/tmp'); import irssg; base=os.path.dirname(irssg.__file__); print(os.path.join(base,'bin','irssg'))")
          echo "IRSSG_BIN=$IRSSG_BIN"
          ls -l "$IRSSG_BIN"
          file "$IRSSG_BIN" || true
          ldd "$IRSSG_BIN" || true
          ldd -v "$IRSSG_BIN" || true

      - name: Debug irssg launcher
        run: |
          set -euxo pipefail
          which irssg
          file "$(which irssg)" || true
          head -n 5 "$(which irssg)" || true
          python -c "import os; os.chdir('/tmp'); import irssg; print('irssg pkg:', irssg.__file__)"

      - name: Install runtime system libs (LAPACK/BLAS)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y liblapack3 libblas3 gdb

      - name: Run irssg PW/WANN tests (if present)
        run: |
          set -euxo pipefail
          if [ -d test/pw ]; then
            echo "Found ./test/pw; running PW test..."
            pushd test/pw
            export IRSSG_DEBUG=1
            export IRSSG_FDBG=1
            export GFORTRAN_UNBUFFERED_ALL=1
            export GFORTRAN_ERROR_BACKTRACE=1
            export GFORTRAN_SHOW_LOCUS=1
            export OMP_NUM_THREADS=1
            export OPENBLAS_NUM_THREADS=1
            IRSSG_BIN=$(python -c "import os; os.chdir('/tmp'); import irssg; base=os.path.dirname(irssg.__file__); print(os.path.join(base,'bin','irssg'))")
            echo "Command: env LD_DEBUG=libs,files LD_DEBUG_OUTPUT=loader $IRSSG_BIN -nk 1 3 -nb 101 112"
            timeout 30s env LD_DEBUG=libs,files LD_DEBUG_OUTPUT=loader "$IRSSG_BIN" -nk 1 3 -nb 101 112 || true
            echo "Command: python -m irssg.cli -nk 1 3 -nb 101 112"
            timeout 120s stdbuf -oL -eL python -m irssg.cli -nk 1 3 -nb 101 112 2>&1 | tee run.log || true
            unset OPENBLAS_NUM_THREADS
            unset OMP_NUM_THREADS
            unset GFORTRAN_SHOW_LOCUS
            unset GFORTRAN_ERROR_BACKTRACE
            unset GFORTRAN_UNBUFFERED_ALL
            unset IRSSG_FDBG
            unset IRSSG_DEBUG
            echo "Checking for TOTAL END in PW log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/pw directory. Skipping PW test."
          fi

          if [ -d test/wann ]; then
            echo "Found ./test/wann; running WANN test..."
            pushd test/wann
            export IRSSG_DEBUG=1
            export IRSSG_FDBG=1
            export GFORTRAN_UNBUFFERED_ALL=1
            export GFORTRAN_ERROR_BACKTRACE=1
            export GFORTRAN_SHOW_LOCUS=1
            export OMP_NUM_THREADS=1
            export OPENBLAS_NUM_THREADS=1
            echo "Command: python -m irssg.cli -wann -nk 1 3 -nb 11 72"
            timeout 120s stdbuf -oL -eL python -m irssg.cli -wann -nk 1 3 -nb 11 72 2>&1 | tee run.log || true
            unset OPENBLAS_NUM_THREADS
            unset OMP_NUM_THREADS
            unset GFORTRAN_SHOW_LOCUS
            unset GFORTRAN_ERROR_BACKTRACE
            unset GFORTRAN_UNBUFFERED_ALL
            unset IRSSG_FDBG
            unset IRSSG_DEBUG
            echo "Checking for TOTAL END in WANN log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/wann directory. Skipping WANN test."
          fi

      - name: GDB backtrace (PW/WANN) if tests fail
        if: always()
        run: |
          set -euxo pipefail
          if [ -d test/pw ] && [ -f test/pw/run.log ] && ! grep -q "TOTAL END" test/pw/run.log; then
            pushd test/pw
            IRSSG_BIN=$(python -c "import os; os.chdir('/tmp'); import irssg; base=os.path.dirname(irssg.__file__); print(os.path.join(base,'bin','irssg'))")
            echo "Running gdb for PW: $IRSSG_BIN -nk 1 3 -nb 101 112"
            IRSSG_FDBG=1 IRSSG_DEBUG=1 timeout 120s gdb -q -batch \
              -ex "set pagination off" \
              -ex "run -nk 1 3 -nb 101 112" \
              -ex "bt" \
              --args "$IRSSG_BIN" -nk 1 3 -nb 101 112 > gdb_pw.txt 2>&1 || true
            popd
          fi
          if [ -d test/wann ] && [ -f test/wann/run.log ] && ! grep -q "TOTAL END" test/wann/run.log; then
            pushd test/wann
            IRSSG_BIN=$(python -c "import os; os.chdir('/tmp'); import irssg; base=os.path.dirname(irssg.__file__); print(os.path.join(base,'bin','irssg'))")
            echo "Running gdb for WANN: $IRSSG_BIN --wann -nk 1 3 -nb 11 72"
            IRSSG_FDBG=1 IRSSG_DEBUG=1 timeout 120s gdb -q -batch \
              -ex "set pagination off" \
              -ex "run --wann -nk 1 3 -nb 11 72" \
              -ex "bt" \
              --args "$IRSSG_BIN" --wann -nk 1 3 -nb 11 72 > gdb_wann.txt 2>&1 || true
            popd
          fi

      - name: Upload PW/WANN logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: irssg-logs-${{ matrix.python-version }}
          path: |
            test/pw/run.log
            test/pw/loader*
            test/pw/gdb_pw.txt
            test/wann/run.log
            test/wann/gdb_wann.txt
