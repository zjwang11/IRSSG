name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Decompress repo data (identify.pkl, symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f src_mom2ssg/ssg_data/identify.pkl.tar.gz ]; then
            tar -xzf src_mom2ssg/ssg_data/identify.pkl.tar.gz -C src_mom2ssg/ssg_data
          fi
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Build wheels (manylinux_2_27, x86_64 + aarch64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64 aarch64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_27"
          CIBW_MANYLINUX_AARCH64_IMAGE: "manylinux_2_27"
        with:
          output-dir: wheelhouse

      - name: Build wheels (manylinux_2_28, x86_64 + aarch64)
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: "x86_64 aarch64"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_28"
          CIBW_MANYLINUX_AARCH64_IMAGE: "manylinux_2_28"
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test 3.13 â†’ 3.8 in descending order
        python-version: ['3.13','3.12','3.11','3.10','3.9','3.8']
    steps:
      - name: Checkout
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Decompress repo test data (symm_hr.dat)
        run: |
          set -euxo pipefail
          if [ -f test/wann/symm_hr.dat.tar.gz ]; then
            tar -xzf test/wann/symm_hr.dat.tar.gz -C test/wann
          fi

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Preinstall runtime deps (prefer wheels; fallback to source)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          # Prefer binary wheels; try a wheels-only resolution first
          export PIP_PREFER_BINARY=1
          export PIP_CONSTRAINT=constraints.txt
          if ! python -m pip install -c constraints.txt --only-binary=:all: \
              numpy scipy spglib pymatgen phonopy h5py; then
            echo "No full wheel solution found; allowing sdist fallback..."
            python -m pip install -c constraints.txt \
              numpy scipy spglib pymatgen phonopy h5py
          fi
          # Ensure importlib_resources for Python < 3.9 with the same two-pass logic
          python - << 'PY'
          import sys, subprocess
          if sys.version_info < (3,9):
              try:
                  subprocess.check_call([sys.executable, "-m", "pip", "install", "-c", "constraints.txt", "--only-binary", ":all:", "importlib_resources"])
              except Exception:
                  subprocess.check_call([sys.executable, "-m", "pip", "install", "-c", "constraints.txt", "importlib_resources"])
          PY

      - name: Install wheel (with deps)
        run: |
          python -m pip install --upgrade pip
          # Ensure importlib_resources for Python < 3.9 (fallback used by CLI)
          python - << 'PY'
          import sys, subprocess
          if sys.version_info < (3,9):
              subprocess.check_call([sys.executable, "-m", "pip", "install", "--only-binary", ":all:", "importlib_resources"])
          PY
          pyver=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          target=$(ls dist/*${pyver}*.whl 2>/dev/null | head -n1 || true)
          if [ -z "$target" ]; then echo "No matching wheel for $pyver"; ls -la dist; exit 1; fi
          echo "Installing wheel: $target"
          # Install our wheel without pulling deps (h5py predetermined above)
          python -m pip install --no-deps "$target"
          tmpdir=$(mktemp -d)
          cd "$tmpdir"
          python -c "import irssg, irssg.cli; print('import-ok')"
          python - << 'PY'
          import sys, os
          print('sys.path[0:3]:', sys.path[0:3])
          try:
              import irssg
              print('irssg file:', irssg.__file__)
              base = os.path.dirname(irssg.__file__)
              print('irssg contents:', os.listdir(base))
              ssg_dir = os.path.join(base, 'ssg')
              print('irssg/ssg exists:', os.path.isdir(ssg_dir))
              if os.path.isdir(ssg_dir):
                  print('irssg/ssg contents:', os.listdir(ssg_dir))
              import irssg.ssg.MOM2SSG as m
              print('mom2ssg-ok', m.__name__)
          except Exception as e:
              import traceback; traceback.print_exc(); raise
          PY

      - name: Run irssg PW/WANN tests (if present)
        run: |
          set -euxo pipefail
          if [ -d test/pw ]; then
            echo "Found ./test/pw; running PW test..."
            pushd test/pw
            echo "Command: irssg -nk 1 3 -nb 101 112"
            timeout 120s irssg -nk 1 3 -nb 101 112 | tee run.log || true
            echo "Checking for TOTAL END in PW log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/pw directory. Skipping PW test."
          fi

          if [ -d test/wann ]; then
            echo "Found ./test/wann; running WANN test..."
            pushd test/wann
            echo "Command: irssg -wann -nk 1 3 -nb 11 72"
            timeout 120s irssg -wann -nk 1 3 -nb 11 72 | tee run.log || true
            echo "Checking for TOTAL END in WANN log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/wann directory. Skipping WANN test."
          fi
