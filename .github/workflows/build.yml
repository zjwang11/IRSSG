name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build wheels with cibuildwheel (Linux only)
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test 3.12 â†’ 3.8 in descending order
        python-version: ['3.12','3.11','3.10','3.9','3.8']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Preinstall runtime deps
        run: |
          python -m pip install --upgrade pip
          # Prefer binary h5py to avoid source builds
          python -m pip install --only-binary=:all: "h5py" || true
          # Required deps for MOM2SSG
          python -m pip install "numpy>=1.20.1" "scipy>=1.5.4" "spglib>=1.15.0" "pymatgen>=2021.2.8" "phonopy>=2.7.0"
          # Ensure importlib_resources for Python < 3.9
          python - << 'PY'
          import sys, subprocess
          if sys.version_info < (3,9):
              subprocess.check_call([sys.executable, "-m", "pip", "install", "importlib_resources"])
          PY

      - name: Install wheel (with deps)
        run: |
          python -m pip install --upgrade pip
          # Prefer binary h5py to avoid source builds (no version pin)
          python -m pip install --only-binary=:all: "h5py" || true
          # Ensure importlib_resources for Python < 3.9 (fallback used by CLI)
          python - << 'PY'
          import sys, subprocess
          if sys.version_info < (3,9):
              subprocess.check_call([sys.executable, "-m", "pip", "install", "importlib_resources"])
          PY
          pyver=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          target=$(ls dist/*${pyver}*.whl 2>/dev/null | head -n1 || true)
          if [ -z "$target" ]; then echo "No matching wheel for $pyver"; ls -la dist; exit 1; fi
          echo "Installing wheel: $target"
          # Install our wheel without pulling deps (h5py predetermined above)
          python -m pip install --no-deps "$target"
          tmpdir=$(mktemp -d)
          cd "$tmpdir"
          python -c "import irssg_pkg, irssg_pkg.cli; print('import-ok')"
          python - << 'PY'
          import sys, os
          print('sys.path[0:3]:', sys.path[0:3])
          try:
              import irssg_pkg
              print('irssg_pkg file:', irssg_pkg.__file__)
              base = os.path.dirname(irssg_pkg.__file__)
              print('irssg_pkg contents:', os.listdir(base))
              ssg_dir = os.path.join(base, 'ssg')
              print('irssg_pkg/ssg exists:', os.path.isdir(ssg_dir))
              if os.path.isdir(ssg_dir):
                  print('irssg_pkg/ssg contents:', os.listdir(ssg_dir))
              import irssg_pkg.ssg.MOM2SSG as m
              print('mom2ssg-ok', m.__name__)
          except Exception as e:
              import traceback; traceback.print_exc(); raise
          PY

      - name: Run irssg PW/WANN tests (if present)
        run: |
          set -euxo pipefail
          if [ -d test/pw ]; then
            echo "Found ./test/pw; running PW test..."
            pushd test/pw
            echo "Command: irssg -nk 1 3 -nb 101 112"
            timeout 120s irssg -nk 1 3 -nb 101 112 | tee run.log || true
            echo "Checking for TOTAL END in PW log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/pw directory. Skipping PW test."
          fi

          if [ -d test/wann ]; then
            echo "Found ./test/wann; running WANN test..."
            pushd test/wann
            echo "Command: irssg -wann -nk 1 3 -nb 11 72"
            timeout 120s irssg -wann -nk 1 3 -nb 11 72 | tee run.log || true
            echo "Checking for TOTAL END in WANN log..."
            grep -q "TOTAL END" run.log
            popd
          else
            echo "No ./test/wann directory. Skipping WANN test."
          fi
