name: Build Linux Wheels (cibuildwheel + gfortran)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build wheels with cibuildwheel (Linux only)
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  test-installed:
    needs: linux-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test on versions with widely available binary deps
        python-version: ['3.8','3.9','3.10','3.11','3.12']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: dist

      - name: Install wheel (with deps)
        run: |
          python -m pip install --upgrade pip
          # Force h5py 3.14.0 as binary to avoid source builds
          python -m pip install --only-binary=:all: "h5py==3.14.0" || true
          pyver=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          target=$(ls dist/*${pyver}*.whl 2>/dev/null | head -n1 || true)
          if [ -z "$target" ]; then echo "No matching wheel for $pyver"; ls -la dist; exit 1; fi
          echo "Installing wheel: $target"
          # Install our wheel without pulling deps (h5py predetermined above)
          python -m pip install --no-deps "$target"
          tmpdir=$(mktemp -d)
          cd "$tmpdir"
          python -c "import irssg_pkg, irssg_pkg.cli; print('import-ok')"
          python - << 'PY'
          import sys, os
          print('sys.path[0:3]:', sys.path[0:3])
          try:
              import irssg_pkg
              print('irssg_pkg file:', irssg_pkg.__file__)
              base = os.path.dirname(irssg_pkg.__file__)
              print('irssg_pkg contents:', os.listdir(base))
              ssg_dir = os.path.join(base, 'ssg')
              print('irssg_pkg/ssg exists:', os.path.isdir(ssg_dir))
              if os.path.isdir(ssg_dir):
                  print('irssg_pkg/ssg contents:', os.listdir(ssg_dir))
              import irssg_pkg.ssg.MOM2SSG as m
              print('mom2ssg-ok', m.__name__)
          except Exception as e:
              import traceback; traceback.print_exc(); raise
          PY

      - name: Run irssg in test directory (if present)
        run: |
          set -euxo pipefail
          if [ -d test ]; then
            echo "Found ./test directory; running irssg..."
            cd test
            timeout 90s irssg | tee run.log || true
            echo "Last line:"; tail -1 run.log || true
            tail -1 run.log | grep -q "TOTAL END"
          else
            echo "No ./test directory. Skipping runtime test."
          fi
